// Generated by CoffeeScript 1.8.0
var Mailbox, Message, OrphanRemoval, Process, RemoveAllMessagesFromMailbox, Scheduler, async, log, ramStore, safeLoop,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

ramStore = require('../models/store_account_and_boxes');

Message = require('../models/message');

Mailbox = require('../models/mailbox');

safeLoop = require('../utils/safeloop');

Process = require('./_base');

RemoveAllMessagesFromMailbox = require('./message_remove_by_mailbox');

Scheduler = require('./_scheduler');

log = require('../utils/logging')('process:removeorphans');

async = require('async');

module.exports = OrphanRemoval = (function(_super) {
  __extends(OrphanRemoval, _super);

  function OrphanRemoval() {
    this.removeOrphansMessageFromMailboxes = __bind(this.removeOrphansMessageFromMailboxes, this);
    this.getOrphanMessageMailboxesIDs = __bind(this.getOrphanMessageMailboxesIDs, this);
    return OrphanRemoval.__super__.constructor.apply(this, arguments);
  }

  OrphanRemoval.prototype.code = 'orphan-removal';

  OrphanRemoval.prototype.initialize = function(options, callback) {
    return async.series([this.removeMailboxOrphans, this.forgetDestroyedBoxes, this.getOrphanMessageMailboxesIDs, this.removeOrphansMessageFromMailboxes, this.destroyNoBoxMessages], callback);
  };

  OrphanRemoval.prototype.removeMailboxOrphans = function(callback) {
    log.debug("removeOrphans");
    return safeLoop(ramStore.getOrphanBoxes(), function(box, next) {
      return box.destroy(next);
    }, function(errors) {
      var err, _i, _len;
      for (_i = 0, _len = errors.length; _i < _len; _i++) {
        err = errors[_i];
        if (-1 === err.message.indexOf('not found')) {
          log.error('failed to delete box', err);
        }
      }
      return callback(null);
    });
  };

  OrphanRemoval.prototype.forgetDestroyedBoxes = function(callback) {
    var account, boxid, toForget, _i, _j, _len, _len1, _ref, _ref1;
    toForget = [];
    _ref = ramStore.getAllAccounts();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      account = _ref[_i];
      _ref1 = account.getReferencedBoxes();
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        boxid = _ref1[_j];
        if (!ramStore.getMailbox(boxid)) {
          toForget.push({
            account: account,
            boxid: boxid
          });
        }
      }
    }
    return safeLoop(toForget, function(_arg, next) {
      var account, boxid;
      account = _arg.account, boxid = _arg.boxid;
      return account.forgetBox(boxid, next);
    }, function(errors) {
      var err, _k, _len2;
      for (_k = 0, _len2 = errors.length; _k < _len2; _k++) {
        err = errors[_k];
        log.error("failed to forget box", err);
      }
      return callback(null);
    });
  };

  OrphanRemoval.prototype.getOrphanMessageMailboxesIDs = function(callback) {
    return Message.rawRequest('byMailboxRequest', {
      reduce: true,
      group_level: 2,
      startkey: ['uid', ''],
      endkey: ['uid', "\uFFFF"]
    }, (function(_this) {
      return function(err, rows) {
        var existingMailboxes, mailboxIDs;
        if (err) {
          return callback(err);
        }
        mailboxIDs = rows.map(function(row) {
          return row.key[1];
        });
        existingMailboxes = ramStore.getMailboxesID();
        _this.toDestroyMailboxIDs = mailboxIDs.filter(function(id) {
          return __indexOf.call(existingMailboxes, id) < 0;
        });
        return callback(null);
      };
    })(this));
  };

  OrphanRemoval.prototype.removeOrphansMessageFromMailboxes = function(callback) {
    return safeLoop(this.toDestroyMailboxIDs, (function(_this) {
      return function(mailboxID, next) {
        var options, removal;
        log.debug("removeOrphans - found orphan from box", mailboxID);
        options = {
          mailboxID: mailboxID,
          toDestroyMailboxIDs: _this.toDestroyMailboxIDs
        };
        removal = new RemoveAllMessagesFromMailbox(options);
        return removal.run(next);
      };
    })(this), function(errors) {
      var err, _i, _len;
      for (_i = 0, _len = errors.length; _i < _len; _i++) {
        err = errors[_i];
        log.error("failed to remove message", err);
      }
      return callback(null);
    });
  };

  OrphanRemoval.prototype.destroyNoBoxMessages = function(callback) {
    var options;
    options = {
      key: ['nobox'],
      reduce: false
    };
    return Message.rawRequest('byMailboxRequest', options, function(err, rows) {
      if (err) {
        return callback(err);
      }
      return safeLoop(rows, function(row, next) {
        return Message.destroy(row.id, next);
      }, function(errors) {
        var _i, _len;
        for (_i = 0, _len = errors.length; _i < _len; _i++) {
          err = errors[_i];
          log.error('fail to destroy orphan msg', err);
        }
        return callback(null);
      });
    });
  };

  return OrphanRemoval;

})(Process);
